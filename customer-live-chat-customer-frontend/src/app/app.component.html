<div class="chat-launcher" [class.chat-launcher--open]="isWidgetOpen()">
  <button
    *ngIf="!isWidgetOpen()"
    type="button"
    class="launch-button"
    (click)="openWidget()"
  >
    Chat with us
  </button>

  <section *ngIf="isWidgetOpen()" class="chat-widget">
    <header class="chat-widget__header">
      <div class="chat-widget__heading">
        <span class="chat-widget__badge">Support</span>
        <h2>Customer Care</h2>
      </div>
      <button type="button" class="close-button" (click)="closeWidget()" aria-label="Close chat widget">
        &times;
      </button>
    </header>

    <div class="chat-widget__status">
      <p>{{ statusText() }}</p>
    </div>

    <div class="chat-widget__body" [class.chat-widget__body--ended]="stage() === ChatStage.Ended">
      <div class="alert alert-error" *ngIf="errorText() as error">
        {{ error }}
      </div>

      <ng-template #welcomeTemplate>
        <div class="chat-greeting">
          <h3>Hi there! How can we help you today?</h3>
          <p>Start a real-time conversation with our support team in seconds.</p>
          <button type="button" class="btn btn-primary" (click)="startConversation()">Start Chat</button>
        </div>
      </ng-template>

      <ng-container [ngSwitch]="stage()">
        <ng-container *ngSwitchCase="ChatStage.Idle" [ngTemplateOutlet]="welcomeTemplate"></ng-container>

        <ng-container *ngSwitchCase="ChatStage.Confirm" [ngTemplateOutlet]="welcomeTemplate"></ng-container>

        <div *ngSwitchCase="ChatStage.Connecting" class="chat-loader">
          <span class="spinner" aria-hidden="true"></span>
          <p>Setting things up...</p>
        </div>

        <div
          *ngSwitchCase="ChatStage.Waiting"
          class="chat-session chat-session--waiting"
        >
          <div class="chat-history" [class.chat-history--empty]="!messages().length" #historyContainer>
            <article
              *ngFor="let message of messages(); trackBy: trackByMessageId"
              [ngClass]="messageClasses(message)"
            >
              <header>
                <span class="sender">{{ message.sender?.displayName || (message.sender?.type === 'AGENT' ? 'Agent' : 'You') }}</span>
                <time>{{ message.timestamp | date : 'shortTime' }}</time>
              </header>
              <p>{{ message.content }}</p>
            </article>
          </div>
          <p class="queue-hint">
            <ng-container *ngIf="queueStatus() as queue">
              You're in line. Position <strong>{{ (queue.position ?? 0) + 1 }}</strong>
              <ng-container *ngIf="formatEstimate(queue.estimatedWait) as wait">
                • Estimated wait {{ wait }}
              </ng-container>
            </ng-container>
            <ng-container *ngIf="!queueStatus()">Hang tight—we'll pair you with the next available specialist.</ng-container>
          </p>
        </div>

        <div *ngSwitchCase="ChatStage.Active" class="chat-session">
          <div class="chat-history" #historyContainer>
            <article
              *ngFor="let message of messages(); trackBy: trackByMessageId"
              [ngClass]="messageClasses(message)"
            >
              <header>
                <span class="sender">{{ message.sender?.displayName || (message.sender?.type === 'AGENT' ? 'Agent' : 'You') }}</span>
                <time>{{ message.timestamp | date : 'shortTime' }}</time>
              </header>
              <p>{{ message.content }}</p>
            </article>
          </div>

          <form class="composer" [formGroup]="messageForm" (ngSubmit)="sendMessage()">
            <label class="sr-only" for="chat-message">Type your message</label>
            <textarea
              id="chat-message"
              formControlName="content"
              placeholder="Type your message…"
              rows="3"
              [disabled]="!canSendMessages()"
              (keydown.enter)="onComposerKeydown($event)"
            ></textarea>
            <div class="composer__actions">
              <button type="submit" class="btn btn-primary" [disabled]="messageForm.invalid || !canSendMessages() || isSending()">
                {{ isSending() ? 'Sending...' : 'Send' }}
              </button>
            </div>
          </form>
        </div>

        <div *ngSwitchCase="ChatStage.Ended" class="chat-session chat-session--ended">
          <div class="chat-history chat-history--inactive" #historyContainer>
            <article
              *ngFor="let message of messages(); trackBy: trackByMessageId"
              [ngClass]="messageClasses(message)"
            >
              <header>
                <span class="sender">{{ message.sender?.displayName || (message.sender?.type === 'AGENT' ? 'Agent' : 'You') }}</span>
                <time>{{ message.timestamp | date : 'shortTime' }}</time>
              </header>
              <p>{{ message.content }}</p>
            </article>
          </div>
          <div class="chat-session__footer">
            <p>The conversation has ended. Start a new chat anytime.</p>
            <button type="button" class="btn btn-primary" (click)="restartChat()">Start New Chat</button>
          </div>
        </div>

        <ng-container *ngSwitchDefault [ngTemplateOutlet]="welcomeTemplate"></ng-container>
      </ng-container>
    </div>
  </section>
</div>

